#!/usr/bin/env bash
#
# bootstrap installs things.

cd "$(dirname "$0")/.."
DOTFILES_ROOT=$(pwd -P)

set -e

# Shared backup directory for this run -- all replaced configs go here
BACKUP_DIR="$HOME/.dotfiles_backup/$(date +%Y%m%d_%H%M%S)"
export BACKUP_DIR

echo ''

info () {
  printf "\r  [ \033[00;34m..\033[0m ] $1\n"
}

user () {
  printf "\r  [ \033[0;33m??\033[0m ] $1\n"
}

success () {
  printf "\r\033[2K  [ \033[00;32mOK\033[0m ] $1\n"
}

fail () {
  printf "\r\033[2K  [\033[0;31mFAIL\033[0m] $1\n"
  echo ''
  exit
}

setup_gitconfig () {
  if ! [ -f git/gitconfig.local.symlink ]
  then
    info 'setup gitconfig'

    git_credential='cache'
    if [ "$(uname -s)" == "Darwin" ]
    then
      git_credential='osxkeychain'
    fi

    user ' - What is your github author name?'
    read -e git_authorname
    user ' - What is your github author email?'
    read -e git_authoremail

    sed -e "s/AUTHORNAME/$git_authorname/g" -e "s/AUTHOREMAIL/$git_authoremail/g" -e "s/GIT_CREDENTIAL_HELPER/$git_credential/g" git/gitconfig.local.symlink.example > git/gitconfig.local.symlink

    success 'gitconfig'
  fi
}


backup_file () {
  local file=$1
  if [ -e "$file" ] || [ -L "$file" ]; then
    mkdir -p "$BACKUP_DIR"
    local basename=$(basename "$file")
    mv "$file" "$BACKUP_DIR/$basename"
    success "backed up $file to $BACKUP_DIR/$basename"
  fi
}

link_file () {
  local src=$1 dst=$2

  if [ -L "$dst" ]; then
    local currentSrc="$(readlink "$dst")"
    if [ "$currentSrc" == "$src" ]; then
      success "already linked $dst"
      return
    fi
    # Existing symlink points elsewhere -- back it up
    backup_file "$dst"
  elif [ -f "$dst" ] || [ -d "$dst" ]; then
    # Existing real file/dir -- back it up
    backup_file "$dst"
  fi

  ln -s "$src" "$dst"
  success "linked $src to $dst"
}

install_dotfiles () {
  info 'installing dotfiles'

  for src in $(find -H "$DOTFILES_ROOT" -maxdepth 2 -name '*.symlink' -not -path '*.git*')
  do
    dst="$HOME/.$(basename "${src%.*}")"
    link_file "$src" "$dst"
  done

  if [ -d "$BACKUP_DIR" ]; then
    info "existing configs backed up to $BACKUP_DIR"
  fi
}

setup_conda () {
  user ' - Do you want to install Miniconda? [y/N]'
  read -n 1 install_conda
  echo ''
  if [ "$install_conda" == "y" ] || [ "$install_conda" == "Y" ]
  then
    info "installing miniconda"
    if bash "$DOTFILES_ROOT/script/conda-setup"
    then
      success "miniconda installed"
    else
      fail "error installing miniconda"
    fi
  else
    success "skipped miniconda"
  fi
}

setup_host_role () {
  if ! [ -f "$DOTFILES_ROOT/host_role" ]
  then
    info 'setup host role'
    user ' - What role is this machine? [mac/linux-desktop/hpc]'
    read -e host_role
    if [ -n "$host_role" ] && [ -f "$DOTFILES_ROOT/hosts/${host_role}.sh" ]
    then
      echo "$host_role" > "$DOTFILES_ROOT/host_role"
      success "host role set to $host_role"
    else
      user " - No config found for '$host_role', skipping"
    fi
  fi
}

setup_localrc () {
  if ! [ -f localrc.symlink ]
  then
    info 'creating localrc from template'
    cp localrc.symlink.example localrc.symlink
    success 'localrc created â€” add machine-specific env vars to ~/.localrc'
  fi
}

setup_gitconfig
setup_localrc
setup_host_role
install_dotfiles

# If we're on a Mac, let's install and setup homebrew.
if [ "$(uname -s)" == "Darwin" ]
then
  info "installing dependencies"
  if source bin/dot | while read -r data; do info "$data"; done
  then
    success "dependencies installed"
  else
    fail "error installing dependencies"
  fi
fi

# Optional: install conda
if ! [ -d "$HOME/.miniconda" ]
then
  setup_conda
fi

# Optional tool installation (rust, starship, claude, oh-my-zsh, etc.)
info 'checking optional tools'
bash "$DOTFILES_ROOT/script/install"

echo ''
echo '  All installed!'
