#!/usr/bin/env bash
#
# Update all dependencies that don't require root access.

set -e

cd "$(dirname "$0")"/..

info () {
  printf "\r  [ \033[00;34m..\033[0m ] $1\n"
}

success () {
  printf "\r\033[2K  [ \033[00;32mOK\033[0m ] $1\n"
}

skip () {
  printf "\r\033[2K  [ \033[00;33m--\033[0m ] $1\n"
}

# Refresh symlinks
info "refreshing symlinks"
DOTFILES_ROOT="$(cd "$(dirname "$0")/.." && pwd -P)"
BACKUP_DIR="$HOME/.dotfiles_backup/$(date +%Y%m%d_%H%M%S)"

backup_file () {
  local file=$1
  if [ -e "$file" ] || [ -L "$file" ]; then
    mkdir -p "$BACKUP_DIR"
    local basename=$(basename "$file")
    mv "$file" "$BACKUP_DIR/$basename"
    success "backed up $file to $BACKUP_DIR/$basename"
  fi
}

link_file () {
  local src=$1 dst=$2
  if [ -L "$dst" ]; then
    local currentSrc="$(readlink "$dst")"
    if [ "$currentSrc" == "$src" ]; then
      return  # already correct, silent skip
    fi
    backup_file "$dst"
  elif [ -f "$dst" ] || [ -d "$dst" ]; then
    backup_file "$dst"
  fi
  ln -s "$src" "$dst"
  success "linked $(basename "$src")"
}

for src in $(find -H "$DOTFILES_ROOT" -maxdepth 2 -name '*.symlink' -not -path '*.git*'); do
  dst="$HOME/.$(basename "${src%.*}")"
  link_file "$src" "$dst"
done

if [ -d "$BACKUP_DIR" ]; then
  info "replaced configs backed up to $BACKUP_DIR"
fi
success "symlinks"

# Homebrew
if command -v brew >/dev/null 2>&1; then
  info "brew update && upgrade"
  brew update --quiet
  brew upgrade
  brew cleanup
  success "homebrew"
else
  skip "homebrew (not installed)"
fi

# Rust toolchain
if [ -f "$HOME/.cargo/env" ]; then
  . "$HOME/.cargo/env"
fi
if command -v rustup >/dev/null 2>&1; then
  info "rustup update"
  rustup update
  success "rustup"
else
  skip "rustup (not installed)"
fi

# Cargo-installed binaries
if command -v cargo >/dev/null 2>&1; then
  info "cargo install-update"
  cargo install-update -a
  success "cargo binaries"
else
  skip "cargo (not installed)"
fi

# Vim plugins
if command -v vim >/dev/null 2>&1 && [ -f "$HOME/.vim/autoload/plug.vim" ]; then
  info "vim +PlugUpdate"
  vim +PlugUpdate +qall
  success "vim plugins"
else
  skip "vim plugins (vim or plug.vim not found)"
fi

if command -v nvim >/dev/null 2>&1 && [ -f "$HOME/.local/share/nvim/site/autoload/plug.vim" ]; then
  info "nvim +PlugUpdate"
  nvim +PlugUpdate +qall
  success "nvim plugins"
else
  skip "nvim plugins (nvim or plug.vim not found)"
fi

# Oh My Zsh
if [ -d "$HOME/.oh-my-zsh" ]; then
  info "oh-my-zsh update"
  env ZSH="$HOME/.oh-my-zsh" sh "$HOME/.oh-my-zsh/tools/upgrade.sh"
  success "oh-my-zsh"
else
  skip "oh-my-zsh (not installed)"
fi

# Starship (Linux only â€” macOS handled by brew upgrade)
if [ "$(uname -s)" = "Linux" ] && command -v starship >/dev/null 2>&1; then
  info "starship update"
  curl -sS https://starship.rs/install.sh | sh -s -- -y --bin-dir "$HOME/.dotfiles/bin"
  success "starship"
fi

# Pixi
if command -v pixi >/dev/null 2>&1; then
  info "pixi self-update"
  pixi self-update
  success "pixi"
else
  skip "pixi (not installed)"
fi

echo ""
success "all updates complete"
